# PROCESSORS SYSTEM - COMPLETE DOCUMENTATION

## ğŸ¯ PURPOSE

Multi-agent financial analysis system for Gold (XAUUSD) that:
1. Processes daily market data using 3 specialized LLM agents
2. Builds hierarchical memory (agents learn from past analyses)
3. Outputs lightweight daily JSONs for memory building
4. Generates detailed monthly confluence reports (2+ pages each)

**Key principle:** Daily JSONs are token-efficient (fed to next day). Monthly reports are detailed (human reading).

---

## ğŸ“ ARCHITECTURE OVERVIEW

```
processors/
â”œâ”€â”€ config.py              # API keys, model configs, file mappings
â”œâ”€â”€ base_agent.py          # Shared: load files, save JSON, error handling
â”œâ”€â”€ memory_manager.py      # Build hierarchical context (oldâ†’new, 3-tier)
â”‚
â”œâ”€â”€ agent_market.py        # Gemini-2.5-Flash (technicals + calculos)
â”œâ”€â”€ agent_macro.py         # Qwen-235B (calendar + fundamentals + monthly_data)
â”œâ”€â”€ agent_narrative.py     # Meta-Llama-3.3-70B (news + forums)
â”‚
â”œâ”€â”€ run_all.py             # Orchestrator: process date range day-by-day
â”œâ”€â”€ report_generator.py    # Synthesize daily JSONs â†’ monthly markdown reports
â””â”€â”€ generate_reports.py    # CLI for report generation

TEXT/
â”œâ”€â”€ data_by_date/          # Input: single-day data files
â”‚   â””â”€â”€ {date}/            # e.g., 2024-01-15/
â”‚       â”œâ”€â”€ technicals.txt
â”‚       â”œâ”€â”€ calculos.txt
â”‚       â”œâ”€â”€ calendar.txt
â”‚       â”œâ”€â”€ fundamentals.txt
â”‚       â”œâ”€â”€ monthly_data.txt
â”‚       â”œâ”€â”€ news.txt
â”‚       â””â”€â”€ forums.txt
â”‚
â”œâ”€â”€ agent_outputs/         # Output: daily JSONs (lightweight)
â”‚   â”œâ”€â”€ market/            # {date}.json
â”‚   â”œâ”€â”€ macro/             # {date}.json
â”‚   â””â”€â”€ narrative/         # {date}.json
â”‚
â””â”€â”€ reports/               # Output: monthly reports (detailed)
    â”œâ”€â”€ market/            # {start}_{end}.md
    â”œâ”€â”€ macro/             # {start}_{end}.md
    â””â”€â”€ narrative/         # {start}_{end}.md
```

---

## ğŸ¤– THREE AGENT SYSTEM

| Agent | Model | Files | Focus | Temp |
|-------|-------|-------|-------|------|
| **MARKET** | Gemini-2.5-Flash | technicals.txt + calculos.txt | Price action, volatility, regime detection | 0.3 |
| **MACRO** | Qwen-235B | calendar.txt + fundamentals.txt + monthly_data.txt | Fed policy, rates, inflation, real rates | 0.2 |
| **NARRATIVE** | Meta-Llama-3.3-70B | news.txt + forums.txt | Sentiment, catalysts, positioning | 0.4 |

**Key:** Each agent specializes in one domain. Outputs are independent but complementary.

---

## ğŸ“‹ DATA FILE FORMATS

### technicals.txt (Market Agent)
```
=== MARKET: 2025-12-08 ===

XAUUSD(Gold)
O:4198.3|H:4218.76|L:4176.0|C:4189.89|V:259493
E9:4185.82|E21:4145.25|E50:4036.24|E200:3561.13
RSI:58.66|MACD:46.75|SIG:45.68|HIST:1.07
ADX:21.16|+DI:25.5|-DI:16.8
BBU:4266.72|BBM:4147.51|BBL:4028.31|WIDTH:5.75
ATR:73.31|STOCH_K:69.25|STOCH_D:74.26
SIG:EMA_BULL_STACK,ABOVE_CLOUD

USA500.IDX(S&P500)
[similar format]

VOL.IDX(VIX)
[similar format]

DOLLAR.IDX(DXY)
[similar format]
```

### calculos.txt (Market Agent)
```
=== DEEPIN: 2025-12-08 ===

XAUUSD(Gold)
PARK_VOL:0.0119|YZ_VOL:0.1994|VOL_REGIME:high|VOL_PCT:77.13
HURST:0.4483|STATE:mean_reverting
POC:4207.71|VAH:4606.59|VAL:3622.69|ACCUM:-0.1619
SPREAD_EST:0.018|EFFICIENCY:0.1435
BULL_P:0.25|BEAR_P:0.25|CONSOL_P:0.5

[similar for SPX, VIX, DXY]
```

**Other files:** (structure TBD based on actual data)
- calendar.txt â†’ Economic events, Fed speeches, data releases
- fundamentals.txt â†’ Treasury yields, credit spreads, inflation metrics
- monthly_data.txt â†’ CPI, PCE, PPI monthly aggregates
- news.txt â†’ Financial headlines, sentiment
- forums.txt â†’ Reddit, Twitter, TradingView discussions

---

## ğŸ§  MEMORY SYSTEM (HIERARCHICAL, OLDâ†’NEW)

**30-day rolling window, 3 compression tiers:**

```
LONG CONTEXT (Days 1-9, oldest)
- Regime labels only
- Example: {"date": "2024-01-01", "regime": "RISK_OFF"}

MEDIUM CONTEXT (Days 10-23, middle 14 days)
- Weekly summaries (2 weeks)
- Example: {
    "period": "2024-01-07 to 2024-01-13",
    "regime": "RISK_ON",
    "key_data": "CPI fell 20bps, Fed dovish, DXY weak 1.5%",
    "conclusion": "Disinflationary trend established"
  }

RECENT CONTEXT (Days 24-30, last 7 days)
- FULL detail (all data + analysis)
- Example: {
    "date": "2024-01-14",
    "data_snapshot": {...},
    "analysis": {...}
  }
```

**Why this matters:**
- Agents see their own past conclusions
- Agents can self-correct ("My Jan 10 assessment was wrong because...")
- Chronological order builds narrative flow

---

## ğŸ“„ DAILY JSON OUTPUT (LIGHTWEIGHT)

**Purpose:** Token-efficient memory for next day's analysis.

```json
{
  "metadata": {
    "agent": "market",
    "date": "2024-01-15",
    "timestamp": "2024-01-15T14:30:00Z",
    "model": "gemini-2.5-flash"
  },
  
  "data_snapshot": {
    "price_action": "Gold $4189, +$25 (+0.6%), broke $4150 resistance",
    "volatility": "VIX 17.42 (low), YZ_VOL 0.1994 (high regime)",
    "correlations": "DXY -0.8% (inverse correlation strong), SPX +0.9%"
  },
  
  "analysis": {
    "regime": "RISK_ON",
    "trend": "BULL_MOMENTUM",
    "key_drivers": ["DXY_WEAK", "BREAKOUT_CONFIRMED", "VOL_COMPRESSION"],
    "reasoning": "Gold broke resistance at $4150 on DXY weakness. High vol regime (77%) + mean-reverting Hurst suggests consolidation after breakout. MACD bull cross confirms momentum.",
    "confidence": 0.82,
    "risk_factors": ["DXY reversal above 99.50 would invalidate breakout"]
  },
  
  "memory_references": {
    "compared_to": [
      "2024-01-10: Was consolidating $4100-4150, awaited breakout",
      "2024-01-14: Resistance test at $4150 failed, bearish"
    ],
    "corrections": [
      "Yesterday's bearish view invalidated by breakout confirmation"
    ]
  }
}
```

**Key fields:**
- `data_snapshot` â†’ Becomes compressed memory for future
- `analysis.reasoning` â†’ Short explanation of conclusion
- `memory_references` â†’ Proves agent is learning/self-correcting

---

## ğŸ“Š MONTHLY REPORT OUTPUT (DETAILED)

**Purpose:** 2+ page confluence analysis for human reading (NOT token-efficient).

### Structure (3 sections):

```markdown
# [AGENT] REPORT
Period: 2024-01-01 to 2024-01-31
Model: [model_name]

---

## ğŸ“Š PART 1: RAW DATA CONFLUENCE

### Price Action Timeline
[ALL raw numbers, dates, metrics from 31 days]
- Jan 1: Gold $4100, VIX 18.5, DXY 103.2
- Jan 5: Gold $4125 (+0.6%), VIX 17.8 (-3.8%)
[... exhaustive data points]

### Technical Indicators Evolution
[Tables of indicators over time]
| Date | RSI | MACD | Hurst | Vol Regime |
[...]

### Volume Profile Analysis
[POC, VAH, VAL shifts over month]

[2-3 pages of raw metrics, NO interpretation yet]

---

## ğŸ”— PART 2: CONFLUENCE & CAUSATION ANALYSIS

### Week 1 (Jan 1-7): Initial Setup
Gold's breakout from $4100 to $4125 was driven by THREE confluent factors:

1. **DXY weakness (-1.5%)**: Dollar index broke support at 103.0
   - Why this matters: Gold has -0.85 inverse correlation with DXY
   - Expected impact: $15-20 upside per 1% DXY decline
   - Actual: $25 move = stronger than expected

2. **Volatility compression**: VIX fell from 18.5 â†’ 17.8
   - Calculos showed YZ_VOL at 77% (high regime) but declining
   - Mean-reverting Hurst (0.45) + vol compression = range setup
   - This explained why breakout stalled at $4150

3. **Technical confluence**: 
   - RSI climbed from 55 â†’ 62 (momentum building)
   - MACD bull cross on Jan 3
   - EMA stack bullish (E9 > E21 > E50)
   - Price above Ichimoku cloud

**CAUSATION CHAIN:**
DXY breakdown â†’ Gold breakout â†’ Vol compression â†’ Consolidation at $4150

### Week 2 (Jan 8-14): Failed Breakdown
[Continue with deep explanations of relationships, causes, effects]

[4-5 pages of deep confluence analysis]

---

## ğŸ¯ PART 3: CONCLUSIONS & IMPLICATIONS

### Current Market State (Jan 31)
**REGIME: RISK_ON (Confidence: 0.78)**

Gold consolidated $4140-4180 after breakout, suggesting:
- Breakout was legitimate (support held above $4100)
- Consolidation = healthy price discovery, not reversal
- Next move likely depends on DXY direction

### What This Means
[Forward implications, scenarios, key levels]

### Self-Correction & Learning
Compared to previous assessments:
- Jan 10: Expected consolidation $4100-4150 â†’ CORRECT
- Jan 14: Called false breakout â†’ WRONG (it held)
- Lesson: Don't dismiss breakouts during DXY weakness

[1-2 pages of conclusions, scenarios, forward outlook]

---
END OF REPORT
```

**Report generation logic:**
1. Load all 31 daily JSONs for agent
2. Extract all `data_snapshot` fields â†’ Part 1
3. Extract all `analysis.reasoning` â†’ Part 2 (expand with LLM)
4. Synthesize conclusions â†’ Part 3

---

## ğŸ”„ WORKFLOW (DAY-BY-DAY PROCESSING)

### Step 1: Daily Processing (run_all.py)
```bash
python processors/run_all.py --start_date 2024-01-01 --end_date 2024-01-31
```

**What happens:**
```
For each date (Jan 1 â†’ Jan 31):
  1. Load data files from TEXT/data_by_date/{date}/
  2. Build hierarchical memory (previous days)
  3. Market agent analyzes â†’ saves JSON
  4. Macro agent analyzes â†’ saves JSON
  5. Narrative agent analyzes â†’ saves JSON
  
Output: 93 JSON files (31 per agent)
```

**Memory builds incrementally:**
- Day 1: No memory (first run)
- Day 2: 1 day of memory
- Day 7: 7 days recent memory
- Day 8+: Full 30-day hierarchical memory

---

### Step 2: Report Generation (generate_reports.py)
```bash
python processors/generate_reports.py --start_date 2024-01-01 --end_date 2024-01-31
```

**What happens:**
```
For each agent (market, macro, narrative):
  1. Load all 31 daily JSONs
  2. Call report_generator.py
  3. LLM synthesizes 3-section markdown report
  4. Save to TEXT/reports/{agent}/{start}_{end}.md

Output: 3 markdown reports (2+ pages each)
```

---

## ğŸ› ï¸ IMPLEMENTATION PHASES

### Phase 1: Foundation âœ…
**Files:** config.py, base_agent.py  
**Test:** Load 1 day of data, save dummy JSON  
**Goal:** File I/O works correctly

### Phase 2: Memory System âœ…
**Files:** memory_manager.py  
**Test:** Process 3 days, verify hierarchical memory builds correctly  
**Goal:** Oldâ†’new chronology confirmed

### Phase 3: Single Agent âœ…
**Files:** agent_market.py  
**Test:** Process 1 week (7 days) with Market agent only  
**Goal:** Daily JSONs correct, memory references work

### Phase 4: All Agents âœ…
**Files:** agent_macro.py, agent_narrative.py, run_all.py  
**Test:** Process 1 month (30 days), all 3 agents  
**Goal:** 90 JSONs generated, no errors

### Phase 5: Report Generation âœ…
**Files:** report_generator.py, generate_reports.py  
**Test:** Generate 3 reports from Phase 4 JSONs  
**Goal:** 3 markdown files (2+ pages each), proper structure

---

## âš™ï¸ CRITICAL RULES

### Rule 1: LLMs Are Stateless
- LLMs don't access files directly
- Python loads files â†’ sends to LLM in prompt
- LLM returns text â†’ Python parses and saves
- Every day requires full context (that's why memory exists)

### Rule 2: Chronological Order (OLDâ†’NEW)
- Memory ALWAYS flows old â†’ new
- Never reverse chronological order
- Builds narrative flow naturally

### Rule 3: Three-Tier Compression
- Recent (7 days): FULL detail
- Medium (14 days): Weekly summaries
- Long (9 days): Regime labels only
- Total window: 30 days

### Rule 4: Data + Analysis (Both Required)
- Save `data_snapshot` (what agent saw)
- Save `analysis` (what agent concluded)
- Both needed for memory building

### Rule 5: Self-Correction Required
- Agents must reference past conclusions
- Agents must identify corrections
- `memory_references` field is mandatory

### Rule 6: Error Tolerance
- Handle missing files gracefully
- Handle bad JSON gracefully
- Handle API failures gracefully
- Continue processing other agents if one fails

### Rule 7: First Run Behavior
- Day 1 has no memory (expected)
- Memory builds gradually over first week
- Full hierarchical memory starts Day 8+

### Rule 8: Output Separation
- Daily JSON: Token-efficient (for LLM memory)
- Monthly report: Detailed (for human reading)
- Never mix these purposes

---

## ğŸš¨ COMMON PITFALLS

âŒ **Don't:** Expect LLM to remember previous conversations  
âœ… **Do:** Send full memory context every time

âŒ **Don't:** Use reverse chronological order  
âœ… **Do:** Always old â†’ new

âŒ **Don't:** Store 30 days of full raw data in memory  
âœ… **Do:** Use 3-tier compression

âŒ **Don't:** Combine agents into one mega-prompt  
âœ… **Do:** Keep agents separate and specialized

âŒ **Don't:** Use creative temperatures (0.7+)  
âœ… **Do:** Use analytical temperatures (0.1-0.4)

âŒ **Don't:** Save only conclusions  
âœ… **Do:** Save data_snapshot + analysis

âŒ **Don't:** Skip error handling  
âœ… **Do:** Handle missing files, bad JSON, API failures

---

## ğŸ“ CONFIGURATION (config.py)

```python
AGENT_CONFIGS = {
    "market": {
        "model": "gemini-2.5-flash",
        "provider": "google",
        "files": ["technicals.txt", "calculos.txt"],
        "temperature": 0.3,
        "max_tokens": 2000
    },
    "macro": {
        "model": "Qwen-235B",
        "provider": "cerebras",
        "files": ["calendar.txt", "fundamentals.txt", "monthly_data.txt"],
        "temperature": 0.2,
        "max_tokens": 2000
    },
    "narrative": {
        "model": "Meta-Llama-3.3-70B",
        "provider": "sambanova",
        "files": ["news.txt", "forums.txt"],
        "temperature": 0.4,
        "max_tokens": 2000
    }
}

MEMORY_CONFIG = {
    "recent_days": 7,      # Full detail
    "medium_days": 14,     # Weekly summaries
    "long_days": 9,        # Regime labels only
    "total_window": 30     # Total lookback
}

PATHS = {
    "data_input": "TEXT/data_by_date",
    "agent_outputs": "TEXT/agent_outputs",
    "reports": "TEXT/reports"
}
```

---

## ğŸ¯ AGENT-SPECIFIC FOCUSES

### MARKET AGENT
**Questions to answer:**
1. Is gold trending or mean-reverting? (Hurst exponent)
2. What's volatility regime? (Low/medium/high)
3. Key support/resistance levels? (POC, VAH, VAL)
4. Momentum direction? (RSI, MACD, ADX)
5. What are DXY and VIX doing? (Correlations)

**Output focus:**
- Regime: Breakout, breakdown, or consolidation?
- Trend: Bull momentum, bear momentum, or range-bound?

---

### MACRO AGENT
**Questions to answer:**
1. Is Fed hawkish or dovish?
2. Is yield curve normal, flat, or inverted?
3. What is real interest rate? (T10Y - CPI)
4. Is inflation accelerating or decelerating?
5. Are credit markets stressed?

**Output focus:**
- Regime: Macro environment supportive or hostile to gold?
- Trend: Fed tightening, pivoting, or cutting?

**CRITICAL:** Real Rate = T10Y - CPI (gold hates positive real rates)

---

### NARRATIVE AGENT
**Questions to answer:**
1. What's market sentiment? (Bullish/bearish/neutral)
2. Any major catalysts? (News, events, shocks)
3. What's positioning? (Retail bullish? Institutions bearish?)
4. Are there narrative shifts? (Risk-on â†’ risk-off)
5. What are forums saying? (Reddit, Twitter sentiment)

**Output focus:**
- Regime: Sentiment bullish, bearish, or mixed?
- Trend: Narrative strengthening, weakening, or shifting?

---

## ğŸ” VALIDATION CHECKLIST

Before moving to next phase:

**Phase 1:**
- [ ] config.py has all API keys
- [ ] base_agent.py loads files correctly
- [ ] Can save dummy JSON to correct path

**Phase 2:**
- [ ] memory_manager.py builds 3-tier structure
- [ ] Chronological order confirmed (oldâ†’new)
- [ ] Compression levels correct

**Phase 3:**
- [ ] agent_market.py inherits BaseAgent
- [ ] Daily JSON has all required fields
- [ ] Memory references work correctly
- [ ] Handles first-run (no memory) gracefully

**Phase 4:**
- [ ] All 3 agents produce valid JSONs
- [ ] run_all.py processes date range correctly
- [ ] Error handling works (missing files, bad JSON)
- [ ] 90 JSONs created (30 per agent)

**Phase 5:**
- [ ] report_generator.py synthesizes correctly
- [ ] 3-section structure present
- [ ] 2+ pages per report
- [ ] Markdown formatting clean

---

## ğŸš€ QUICK START

```bash
# 1. Setup
cd processors/
pip install -r requirements.txt

# 2. Configure
# Edit config.py with your API keys

# 3. Test foundation
python test_foundation.py  # Phase 1 test

# 4. Test memory
python test_memory.py  # Phase 2 test

# 5. Run single agent test
python test_single_agent.py  # Phase 3 test

# 6. Run full month
python run_all.py --start_date 2024-01-01 --end_date 2024-01-31

# 7. Generate reports
python generate_reports.py --start_date 2024-01-01 --end_date 2024-01-31
```

---

## ğŸ“š EXPECTED OUTPUTS

### After Step 6 (run_all.py):
```
TEXT/agent_outputs/
â”œâ”€â”€ market/
â”‚   â”œâ”€â”€ 2024-01-01.json
â”‚   â”œâ”€â”€ 2024-01-02.json
â”‚   â””â”€â”€ ... (31 files)
â”œâ”€â”€ macro/
â”‚   â””â”€â”€ ... (31 files)
â””â”€â”€ narrative/
    â””â”€â”€ ... (31 files)
```

### After Step 7 (generate_reports.py):
```
TEXT/reports/
â”œâ”€â”€ market/
â”‚   â””â”€â”€ 2024-01-01_to_2024-01-31.md  (2+ pages)
â”œâ”€â”€ macro/
â”‚   â””â”€â”€ 2024-01-01_to_2024-01-31.md  (2+ pages)
â””â”€â”€ narrative/
    â””â”€â”€ 2024-01-01_to_2024-01-31.md  (2+ pages)
```

---

## ğŸ“ KEY CONCEPTS SUMMARY

1. **Stateless LLMs** â†’ You manage persistence
2. **Explicit memory** â†’ Build and send context each time
3. **Chronological order** â†’ Always old â†’ new
4. **Three-tier compression** â†’ Labels â†’ Summaries â†’ Full
5. **Self-correction** â†’ Reference and revise past conclusions
6. **Data + Analysis** â†’ Save both (for memory)
7. **Error tolerance** â†’ Graceful degradation
8. **Gradual memory** â†’ First 7 days build up
9. **Standardized output** â†’ Same JSON structure
10. **Single responsibility** â†’ Each agent focused

---

## ğŸ“ NEXT STEPS AFTER READING

When starting new conversation, state:
- "I've read PROCESSORS_README.md"
- "I want to work on Phase [X]"
- "Current status: [completed phases]"

This allows continuation without re-explaining entire system.

---

**Last Updated:** 2024-01-26  
**Version:** 1.0  
**System:** CONCIEL - Processors Module  
**Purpose:** Multi-agent financial analysis with hierarchical memory